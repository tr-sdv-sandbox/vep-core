// Copyright 2025 Vehicle Edge Platform Contributors
// SPDX-License-Identifier: Apache-2.0
//
// AVTP Probe - DDS IDL definitions
//
// Defines message types for IEEE 1722 AVTP (Audio/Video Transport Protocol)
// frames, primarily CAN/LIN/FlexRay tunneling over Ethernet.
//
// Note: Uses vss_types.idl for shared Header type.

#include "vss_types.idl"

module avtp_telemetry {

    // ================================================================
    // IEEE 1722 AVTP CAN TUNNELING
    // ================================================================

    enum AcfType {
        ACF_TYPE_CAN,
        ACF_TYPE_CAN_BRIEF,
        ACF_TYPE_LIN,
        ACF_TYPE_FLEXRAY,
        ACF_TYPE_SENSOR,
        ACF_TYPE_GPC
    };

    /**
     * CAN frame flags.
     */
    struct CanFlags {
        boolean is_extended_id;              // Extended (29-bit) vs standard (11-bit) ID
        boolean is_fd;                       // CAN-FD frame
        boolean is_brs;                      // Bit rate switch (CAN-FD)
        boolean is_esi;                      // Error state indicator (CAN-FD)
        boolean is_rtr;                      // Remote transmission request
    };

    /**
     * ACF CAN frame - CAN message encapsulated in AVTP.
     * Maps to IEEE 1722 ACF CAN PDU.
     */
    struct AcfCanFrame {
        vss::types::Header header;
        unsigned long long stream_id;        // AVTP stream identifier
        unsigned long can_id;                // CAN arbitration ID
        octet bus_id;                        // CAN bus identifier (0-31)
        CanFlags flags;
        sequence<octet, 64> payload;         // CAN data (up to 64 bytes for CAN-FD)
        unsigned long long avtp_timestamp;   // AVTP presentation timestamp
        unsigned long sequence_num;          // AVTP sequence number
    };
    #pragma keylist AcfCanFrame stream_id can_id

    /**
     * Batch of CAN frames for efficiency.
     * TSCF (Time-Synchronous Control Format) can carry multiple ACF messages.
     */
    struct AcfCanBatch {
        vss::types::Header header;
        unsigned long long stream_id;
        sequence<AcfCanFrame> frames;
    };
    #pragma keylist AcfCanBatch stream_id

    /**
     * CAN trace (triggered capture for debugging).
     */
    struct CanTrace {
        vss::types::Header header;
        long long start_time_ns;
        long long end_time_ns;
        string trigger_event_id;             // Correlation to triggering event
        sequence<AcfCanFrame> frames;
    };
    #pragma keylist CanTrace

    /**
     * AVTP stream statistics for monitoring.
     */
    struct StreamStats {
        vss::types::Header header;
        unsigned long long stream_id;
        unsigned long long frames_received;
        unsigned long long frames_sent;
        unsigned long long sequence_errors;
        unsigned long long timestamp_errors;
        unsigned long long bytes_total;
        double average_latency_us;
    };
    #pragma keylist StreamStats stream_id

}; // module avtp_telemetry
